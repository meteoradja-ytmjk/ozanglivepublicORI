<% layout('layout') -%>

<div class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
  <div>
    <h2 class="text-2xl font-bold">User Management</h2>
    <p class="text-gray-400 text-sm mt-1">Manage user accounts and permissions</p>
  </div>
  <div>
    <button onclick="openCreateModal()" 
      class="px-4 py-2 bg-primary hover:bg-secondary text-white rounded-lg transition-colors flex items-center">
      <i class="ti ti-plus mr-1.5"></i>
      <span>Create New User</span>
    </button>
  </div>
</div>

<div class="bg-gray-800 rounded-lg p-4 mb-6">
  <div class="flex flex-row items-center gap-3">
    <div class="relative w-full sm:w-80 md:w-96">
      <input type="text" id="searchInput" placeholder="Search users..." 
        class="w-full bg-dark-700 text-white pl-9 pr-4 py-2.5 border border-gray-600 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary">
      <i class="ti ti-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
    </div>
    <div class="w-32">
      <select id="roleFilter" 
        class="w-full bg-dark-700 border border-gray-600 text-white px-3 py-2.5 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary">
        <option value="">All Roles</option>
        <option value="admin">Admin</option>
        <option value="member">Member</option>
      </select>
    </div>
    <div class="w-32">
      <select id="statusFilter" 
        class="w-full bg-dark-700 border border-gray-600 text-white px-3 py-2.5 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary">
        <option value="">All Status</option>
        <option value="active">Active</option>
        <option value="inactive">Inactive</option>
      </select>
    </div>
  </div>
</div>

<div class="bg-gray-800 rounded-lg overflow-hidden">
  <div class="overflow-x-auto">
    <table class="w-full">
      <thead class="bg-dark-700">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">User</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Role</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Status</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Video</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Streaming</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Created</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Actions</th>
        </tr>
      </thead>
      <tbody id="usersTableBody" class="divide-y divide-gray-700">
        <% if (users && users.length > 0) { %>
          <% users.forEach(function(user) { %>
            <tr class="hover:bg-dark-700/50 transition-colors user-row" 
                data-username="<%= user.username.toLowerCase() %>" 
                data-role="<%= user.user_role %>" 
                data-status="<%= user.status %>"
                data-user-id="<%= user.id %>"
                data-can-view="<%= user.can_view_videos !== undefined ? user.can_view_videos : 1 %>"
                data-can-download="<%= user.can_download_videos !== undefined ? user.can_download_videos : 1 %>"
                data-can-delete="<%= user.can_delete_videos !== undefined ? user.can_delete_videos : 1 %>">
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                  <div class="flex-shrink-0 h-10 w-10">
                    <div class="h-10 w-10 rounded-full overflow-hidden ring-2 ring-gray-600">
                      <% if (user.avatar_path) { %>
                        <img src="<%= user.avatar_path %>" alt="<%= user.username %>'s avatar" 
                             class="w-full h-full object-cover" 
                             onerror="this.onerror=null; this.src='/images/default-avatar.jpg';">
                      <% } else { %>
                        <img src="/images/default-avatar.jpg" alt="Default avatar" class="w-full h-full object-cover">
                      <% } %>
                    </div>
                  </div>
                  <div class="ml-4">
                    <div class="text-sm font-medium text-white"><%= user.username %></div>
                    <div class="text-sm text-gray-400">ID: <%= user.id %></div>
                  </div>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full 
                  <%= user.user_role === 'admin' ? 'bg-purple-100 text-purple-800' : 'bg-violet-100 text-violet-800' %>">
                  <%= user.user_role %>
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full 
                  <%= user.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800' %>">
                  <%= user.status %>
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center gap-2 cursor-pointer hover:bg-gray-700/30 rounded p-1 -m-1" data-user-id="<%= user.id %>" data-username="<%= user.username %>" onclick="showVideoModal(this)">
                  <i class="ti ti-video text-gray-400"></i>
                  <span class="text-sm text-gray-400"><%= user.videoCount || 0 %> video</span>
                  <span class="inline-flex px-1.5 py-0.5 text-xs rounded-md bg-gray-600 text-gray-200">
                    <% if (user.totalVideoSize) { %><%= user.totalVideoSize %><% } else { %>0 B<% } %>
                  </span>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400 cursor-pointer hover:bg-gray-700/30 transition-colors" data-user-id="<%= user.id %>" data-username="<%= user.username %>" onclick="showStreamModal(this)">
                <div class="flex flex-col">
                  <div class="flex items-center mb-1">
                    <i class="ti ti-broadcast mr-1"></i>
                    <span><%= user.streamCount || 0 %> stream</span>
                  </div>
                  <div class="flex items-center">
                    <span class="inline-flex px-1.5 py-0.5 text-xs rounded-md <%= user.activeStreamCount >= (user.live_limit || user.defaultLiveLimit || 1) ? 'bg-red-600 text-white' : 'bg-gray-600 text-gray-200' %>">
                      <%= user.activeStreamCount || 0 %>/<%= user.live_limit || user.defaultLiveLimit || 1 %> live
                    </span>
                  </div>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">
                <%= new Date(user.created_at).toLocaleDateString() %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <div class="flex space-x-2">
                  <button class="edit-user-btn text-primary hover:text-accent transition-colors" 
                    title="Edit User"
                    data-user-id="<%= user.id %>"
                    data-username="<%= user.username %>"
                    data-role="<%= user.user_role %>"
                    data-status="<%= user.status %>"
                    data-avatar="<%= user.avatar_path || '' %>"
                    data-live-limit="<%= user.live_limit || '' %>"
                    data-storage-limit="<%= user.storage_limit || '' %>">
                    <i class="ti ti-edit"></i>
                  </button>
                  
                  <% if (user.id !== req.session.userId) { %>
                    <button class="delete-user-btn text-red-400 hover:text-red-300 transition-colors" 
                      title="Delete User"
                      data-user-id="<%= user.id %>"
                      data-username="<%= user.username %>">
                      <i class="ti ti-trash"></i>
                    </button>
                  <% } %>
                </div>
              </td>
            </tr>
          <% }); %>
        <% } else { %>
          <tr id="defaultEmptyState">
            <td colspan="7" class="px-6 py-8 text-center text-gray-400">
              <i class="ti ti-users text-4xl mb-2"></i>
              <p>No users found</p>
            </td>
          </tr>
        <% } %>
        <tr id="searchEmptyState" class="hidden">
          <td colspan="7" class="px-6 py-8 text-center text-gray-400">
            <i class="ti ti-search-off text-4xl mb-2"></i>
            <p>No users match your search criteria</p>
            <p class="text-sm mt-1">Try adjusting your filters or search terms</p>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<div id="editModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden transition-opacity overflow-y-auto">
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-dark-800 rounded-lg shadow-xl w-full max-w-md border border-gray-600/50 transform transition-all opacity-0 scale-95 flex flex-col max-h-[90vh]" id="editModalContent">
      <div class="flex items-center justify-between p-4 border-b border-gray-600/50 flex-shrink-0">
        <div class="flex items-center">
          <h3 class="text-lg font-medium">Edit User</h3>
        </div>
        <button onclick="closeEditModal()" class="rounded-full w-8 h-8 flex items-center justify-center text-gray-400 hover:text-white hover:bg-gray-700/50 transition-colors">
          <i class="ti ti-x"></i>
        </button>
      </div>
      
      <div class="p-6 overflow-y-auto flex-1">
        <form id="editUserForm" enctype="multipart/form-data">
          <input type="hidden" id="editUserId" name="userId">
          
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-300 mb-2">Profile Picture</label>
            <div class="flex items-center space-x-4">
              <div class="h-16 w-16 rounded-full overflow-hidden ring-2 ring-gray-600">
                <img id="editUserAvatar" src="/images/default-avatar.jpg" alt="User avatar" class="w-full h-full object-cover">
              </div>
              <div>
                <input type="file" id="editAvatarInput" name="avatar" accept="image/*" class="hidden">
                <button type="button" onclick="document.getElementById('editAvatarInput').click()" 
                  class="px-3 py-1 bg-primary hover:bg-secondary text-white text-sm rounded-lg transition-colors">
                  Change Photo
                </button>
              </div>
            </div>
          </div>

          <div class="mb-4">
            <label for="editUsername" class="block text-sm font-medium text-gray-300 mb-2">Username</label>
            <input type="text" id="editUsername" name="username" required placeholder="Enter username"
              class="w-full bg-dark-700 border border-gray-600 text-white px-3 py-2 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary">
          </div>

          <div class="mb-4">
            <label for="editRole" class="block text-sm font-medium text-gray-300 mb-2">Role</label>
            <select id="editRole" name="role" 
              class="w-full bg-dark-700 border border-gray-600 text-white px-3 py-2 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary">
              <option value="member">Member</option>
              <option value="admin">Admin</option>
            </select>
          </div>

          <div class="mb-4">
            <label for="editStatus" class="block text-sm font-medium text-gray-300 mb-2">Status</label>
            <select id="editStatus" name="status" 
              class="w-full bg-dark-700 border border-gray-600 text-white px-3 py-2 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary">
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
            </select>
          </div>

          <div class="mb-4" id="liveLimitContainer">
            <label for="editLiveLimit" class="block text-sm font-medium text-gray-300 mb-2">
              Live Limit
              <span class="text-xs text-gray-500 ml-1" id="liveLimitHint">(0 = use default)</span>
            </label>
            <input type="number" id="editLiveLimit" name="live_limit" min="0" max="100" placeholder="0"
              class="w-full bg-dark-700 border border-gray-600 text-white px-3 py-2 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary">
            <p class="text-xs text-gray-500 mt-1" id="liveLimitDesc">Maximum simultaneous live streams for this user</p>
          </div>

          <div class="mb-4">
            <label for="editStorageLimit" class="block text-sm font-medium text-gray-300 mb-2">
              Storage Limit
              <span class="text-xs text-gray-500 ml-1">(0 = unlimited)</span>
            </label>
            <div class="flex gap-2">
              <input type="number" id="editStorageLimitValue" min="0" placeholder="0"
                class="flex-1 bg-dark-700 border border-gray-600 text-white px-3 py-2 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary">
              <select id="editStorageLimitUnit" class="w-24 bg-dark-700 border border-gray-600 text-white px-2 py-2 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary">
                <option value="1073741824">GB</option>
                <option value="1048576">MB</option>
                <option value="1099511627776">TB</option>
              </select>
            </div>
            <input type="hidden" id="editStorageLimit" name="storage_limit">
            <p class="text-xs text-gray-500 mt-1">Maximum storage space for this user</p>
            <p class="text-xs text-gray-400 mt-1" id="editStorageUsage"></p>
          </div>

          <div class="mb-6">
            <label for="editPassword" class="block text-sm font-medium text-gray-300 mb-2">New Password (optional)</label>
            <input type="password" id="editPassword" name="password" placeholder="Leave empty to keep current password"
              class="w-full bg-dark-700 border border-gray-600 text-white px-3 py-2 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary">
          </div>
        </form>
      </div>
      
      <div class="flex justify-end p-4 border-t border-gray-600/50 flex-shrink-0">
        <button type="button" onclick="closeEditModal()" 
          class="px-4 py-2 bg-dark-700 hover:bg-dark-600 text-gray-300 rounded-lg transition-colors mr-3">
          Cancel
        </button>
        <button type="submit" form="editUserForm"
          class="px-4 py-2 bg-primary hover:bg-secondary text-white rounded-lg transition-colors">
          Save Changes
        </button>
      </div>
    </div>
  </div>
</div>

<div id="createModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden transition-opacity overflow-y-auto">
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-dark-800 rounded-lg shadow-xl w-full max-w-md border border-gray-600/50 transform transition-all opacity-0 scale-95 flex flex-col max-h-[90vh]" id="createModalContent">
      <div class="flex items-center justify-between p-4 border-b border-gray-600/50 flex-shrink-0">
        <div class="flex items-center">
          <h3 class="text-lg font-medium">Create New User</h3>
        </div>
        <button onclick="closeCreateModal()" class="rounded-full w-8 h-8 flex items-center justify-center text-gray-400 hover:text-white hover:bg-gray-700/50 transition-colors">
          <i class="ti ti-x"></i>
        </button>
      </div>
      
      <div class="p-6 overflow-y-auto flex-1">
        <form id="createUserForm" enctype="multipart/form-data">
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-300 mb-2">Profile Picture</label>
            <div class="flex items-center space-x-4">
              <div class="h-16 w-16 rounded-full overflow-hidden ring-2 ring-gray-600">
                <img id="createUserAvatar" src="/images/default-avatar.jpg" alt="User avatar" class="w-full h-full object-cover">
              </div>
              <div>
                <input type="file" id="createAvatarInput" name="avatar" accept="image/*" class="hidden">
                <button type="button" onclick="document.getElementById('createAvatarInput').click()" 
                  class="px-3 py-1 bg-primary hover:bg-secondary text-white text-sm rounded-lg transition-colors">
                  Choose Photo
                </button>
              </div>
            </div>
          </div>

          <div class="mb-4">
            <label for="createUsername" class="block text-sm font-medium text-gray-300 mb-2">Username</label>
            <input type="text" id="createUsername" name="username" required placeholder="Enter username"
              class="w-full bg-dark-700 border border-gray-600 text-white px-3 py-2 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary">
          </div>

          <div class="mb-4">
            <label for="createRole" class="block text-sm font-medium text-gray-300 mb-2">Role</label>
            <select id="createRole" name="role" 
              class="w-full bg-dark-700 border border-gray-600 text-white px-3 py-2 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary">
              <option value="member">Member</option>
              <option value="admin">Admin</option>
            </select>
          </div>

          <div class="mb-4">
            <label for="createStatus" class="block text-sm font-medium text-gray-300 mb-2">Status</label>
            <select id="createStatus" name="status" 
              class="w-full bg-dark-700 border border-gray-600 text-white px-3 py-2 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary">
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
            </select>
          </div>

          <div class="mb-6">
            <label for="createPassword" class="block text-sm font-medium text-gray-300 mb-2">Password</label>
            <input type="password" id="createPassword" name="password" required placeholder="Enter password"
              class="w-full bg-dark-700 border border-gray-600 text-white px-3 py-2 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary">
          </div>
        </form>
      </div>
      
      <div class="flex justify-end p-4 border-t border-gray-600/50 flex-shrink-0">
        <button type="button" onclick="closeCreateModal()" 
          class="px-4 py-2 bg-dark-700 hover:bg-dark-600 text-gray-300 rounded-lg transition-colors mr-3">
          Cancel
        </button>
        <button type="submit" form="createUserForm"
          class="px-4 py-2 bg-primary hover:bg-secondary text-white rounded-lg transition-colors">
          Create User
        </button>
      </div>
    </div>
  </div>
</div>

<div id="confirmModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden transition-opacity">
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-dark-800 rounded-lg shadow-xl w-full max-w-md border border-gray-600/50 transform transition-all opacity-0 scale-95" id="confirmModalContent">
      <div class="flex items-center justify-between p-4 border-b border-gray-600/50">
        <div class="flex items-center">
          <h3 class="text-lg font-medium" id="modalTitle">Confirm Action</h3>
        </div>
        <button onclick="closeModal()" class="rounded-full w-8 h-8 flex items-center justify-center text-gray-400 hover:text-white hover:bg-gray-700/50 transition-colors">
          <i class="ti ti-x"></i>
        </button>
      </div>
      
      <div class="p-6">
        <p class="text-gray-300" id="modalMessage">Are you sure you want to perform this action?</p>
      </div>
      
      <div class="flex justify-end p-4 border-t border-gray-600/50">
        <button onclick="closeModal()" 
          class="px-4 py-2 bg-dark-700 hover:bg-dark-600 text-gray-300 rounded-lg transition-colors mr-3">
          Cancel
        </button>
        <button id="confirmButton" 
          class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors">
          Confirm
        </button>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="fixed top-16 right-4 bg-dark-800 text-white px-4 py-3 rounded-lg shadow-lg z-50 hidden flex items-center">
  <i id="toast-icon" class="mr-2"></i>
  <span id="toast-message"></span>
</div>

<div id="videoModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 opacity-0 pointer-events-none transition-opacity duration-300">
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-dark-800 rounded-lg shadow-xl w-full max-w-2xl border border-gray-600/50 transform transition-transform duration-300 scale-95" id="videoModalContent">
      <div class="flex items-center justify-between p-4 border-b border-gray-600/50">
        <div class="flex items-center">
          <h3 class="text-lg font-medium" id="videoModalTitle">Video Collection</h3>
        </div>
        <button onclick="closeVideoModal()" class="rounded-full w-8 h-8 flex items-center justify-center text-gray-400 hover:text-white hover:bg-gray-700/50 transition-colors">
          <i class="ti ti-x"></i>
        </button>
      </div>
      
      <div class="p-6 max-h-96 overflow-y-auto">
        <div id="videoList" class="space-y-3">
        </div>
        <div id="videoEmptyState" class="text-center py-12 hidden">
          <div class="w-16 h-16 bg-gray-600/30 rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="ti ti-video-off text-2xl text-gray-400"></i>
          </div>
          <h4 class="text-lg font-medium text-gray-300 mb-2">No Videos Found</h4>
          <p class="text-gray-400 text-sm">This user hasn't uploaded any videos yet.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="streamModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 opacity-0 pointer-events-none transition-opacity duration-300">
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-dark-800 rounded-lg shadow-xl w-full max-w-xl border border-gray-600/50 transform transition-transform duration-300 scale-95" id="streamModalContent">
      <div class="flex items-center justify-between px-4 py-3 border-b border-gray-600/50">
        <h3 class="text-base font-medium" id="streamModalTitle">Stream Collection</h3>
        <button onclick="closeStreamModal()" class="rounded-full w-7 h-7 flex items-center justify-center text-gray-400 hover:text-white hover:bg-gray-700/50 transition-colors">
          <i class="ti ti-x"></i>
        </button>
      </div>
      
      <div class="p-4 max-h-80 overflow-y-auto">
        <div id="streamList">
        </div>
        <div id="streamEmptyState" class="text-center py-8 hidden">
          <div class="w-12 h-12 bg-gray-600/30 rounded-full flex items-center justify-center mx-auto mb-3">
            <i class="ti ti-broadcast-off text-xl text-gray-400"></i>
          </div>
          <h4 class="text-sm font-medium text-gray-300 mb-1">No Streams Found</h4>
          <p class="text-gray-400 text-xs">This user hasn't created any streams yet.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let currentAction = null;

// Function to update Live Limit UI based on role
function updateLiveLimitUI(role, liveLimit) {
  const liveLimitInput = document.getElementById('editLiveLimit');
  const liveLimitHint = document.getElementById('liveLimitHint');
  const liveLimitDesc = document.getElementById('liveLimitDesc');
  
  if (role === 'admin') {
    liveLimitInput.value = '';
    liveLimitInput.placeholder = 'Unlimited';
    liveLimitInput.disabled = true;
    liveLimitInput.classList.add('bg-gray-600', 'cursor-not-allowed');
    liveLimitHint.textContent = '(Admin = Unlimited)';
    liveLimitHint.classList.remove('text-gray-500');
    liveLimitHint.classList.add('text-green-400');
    liveLimitDesc.textContent = 'Admin users have unlimited live streams';
    liveLimitDesc.classList.remove('text-gray-500');
    liveLimitDesc.classList.add('text-green-400');
  } else {
    liveLimitInput.value = liveLimit || '';
    liveLimitInput.placeholder = '0';
    liveLimitInput.disabled = false;
    liveLimitInput.classList.remove('bg-gray-600', 'cursor-not-allowed');
    liveLimitHint.textContent = '(0 = use default)';
    liveLimitHint.classList.remove('text-green-400');
    liveLimitHint.classList.add('text-gray-500');
    liveLimitDesc.textContent = 'Maximum simultaneous live streams for this user';
    liveLimitDesc.classList.remove('text-green-400');
    liveLimitDesc.classList.add('text-gray-500');
  }
}

function showToast(message, type = 'success') {
  const toast = document.getElementById('toast');
  const toastIcon = document.getElementById('toast-icon');
  const toastMessage = document.getElementById('toast-message');
  
  if (type === 'success') {
    toastIcon.className = 'ti ti-check text-green-400 text-xl mr-2 font-loaded';
  } else {
    toastIcon.className = 'ti ti-x text-red-400 text-xl mr-2 font-loaded';
  }
  
  toast.className = 'fixed top-16 right-4 bg-dark-800 text-white px-4 py-3 rounded-lg shadow-lg z-50';
  toastMessage.textContent = message;
  toast.classList.remove('hidden');
  
  setTimeout(() => {
    toast.classList.add('hidden');
  }, 3000);
}

function openEditModal(userId, username, role, status, avatar, liveLimit, storageLimit) {
  document.getElementById('editUserId').value = userId;
  document.getElementById('editUsername').value = username;
  document.getElementById('editRole').value = role;
  document.getElementById('editStatus').value = status;
  document.getElementById('editPassword').value = '';
  
  // Handle live limit based on role
  updateLiveLimitUI(role, liveLimit);
  
  // Set storage limit
  const storageLimitValue = document.getElementById('editStorageLimitValue');
  const storageLimitUnit = document.getElementById('editStorageLimitUnit');
  const storageLimitHidden = document.getElementById('editStorageLimit');
  
  if (storageLimit && storageLimit > 0) {
    // Convert bytes to appropriate unit
    if (storageLimit >= 1099511627776) { // TB
      storageLimitValue.value = Math.round(storageLimit / 1099511627776);
      storageLimitUnit.value = '1099511627776';
    } else if (storageLimit >= 1073741824) { // GB
      storageLimitValue.value = Math.round(storageLimit / 1073741824);
      storageLimitUnit.value = '1073741824';
    } else { // MB
      storageLimitValue.value = Math.round(storageLimit / 1048576);
      storageLimitUnit.value = '1048576';
    }
    storageLimitHidden.value = storageLimit;
  } else {
    storageLimitValue.value = '';
    storageLimitUnit.value = '1073741824';
    storageLimitHidden.value = '';
  }
  
  // Fetch and display current storage usage
  fetch(`/api/users/${userId}/storage`)
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        const usageEl = document.getElementById('editStorageUsage');
        usageEl.textContent = `Current usage: ${data.storage.formatted.usage}`;
      }
    })
    .catch(err => console.error('Error fetching storage:', err));
  
  const avatarImg = document.getElementById('editUserAvatar');
  if (avatar && avatar !== 'null' && avatar !== '') {
    avatarImg.src = avatar;
  } else {
    avatarImg.src = '/images/default-avatar.jpg';
  }
  
  const modal = document.getElementById('editModal');
  const modalContent = document.getElementById('editModalContent');
  
  modal.classList.remove('hidden');
  
  setTimeout(() => {
    modal.classList.remove('opacity-0');
    modalContent.classList.remove('opacity-0', 'scale-95');
    modalContent.classList.add('opacity-100', 'scale-100');
  }, 10);
}

function openCreateModal() {
  document.getElementById('createUsername').value = '';
  document.getElementById('createRole').value = 'member';
  document.getElementById('createStatus').value = 'active';
  document.getElementById('createPassword').value = '';
  document.getElementById('createUserAvatar').src = '/images/default-avatar.jpg';
  document.getElementById('createAvatarInput').value = '';
  
  const modal = document.getElementById('createModal');
  const modalContent = document.getElementById('createModalContent');
  
  modal.classList.remove('hidden');
  
  setTimeout(() => {
    modal.classList.remove('opacity-0');
    modalContent.classList.remove('opacity-0', 'scale-95');
    modalContent.classList.add('opacity-100', 'scale-100');
  }, 10);
}

function closeCreateModal() {
  const modal = document.getElementById('createModal');
  const modalContent = document.getElementById('createModalContent');
  
  modal.classList.add('opacity-0');
  modalContent.classList.remove('opacity-100', 'scale-100');
  modalContent.classList.add('opacity-0', 'scale-95');
  
  setTimeout(() => {
    modal.classList.add('hidden');
    document.getElementById('createUserForm').reset();
    document.getElementById('createUserAvatar').src = '/images/default-avatar.jpg';
  }, 200);
}

function editUser(userId, username, role, status, avatarPath, liveLimit) {
  openEditModal(userId, username, role, status, avatarPath, liveLimit);
}

// Event delegation for edit and delete buttons
document.addEventListener('DOMContentLoaded', function() {
  // Handle role change to update live limit UI
  const editRoleSelect = document.getElementById('editRole');
  if (editRoleSelect) {
    editRoleSelect.addEventListener('change', function() {
      const currentLiveLimit = document.getElementById('editLiveLimit').value;
      updateLiveLimitUI(this.value, currentLiveLimit);
    });
  }
  
  // Handle edit button clicks
  document.querySelectorAll('.edit-user-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const userId = this.dataset.userId;
      const username = this.dataset.username;
      const role = this.dataset.role;
      const status = this.dataset.status;
      const avatar = this.dataset.avatar;
      const liveLimit = this.dataset.liveLimit;
      const storageLimit = this.dataset.storageLimit;
      openEditModal(userId, username, role, status, avatar, liveLimit, storageLimit);
    });
  });
  
  // Handle storage limit input changes
  const storageLimitValue = document.getElementById('editStorageLimitValue');
  const storageLimitUnit = document.getElementById('editStorageLimitUnit');
  const storageLimitHidden = document.getElementById('editStorageLimit');
  
  function updateStorageLimitHidden() {
    const value = parseInt(storageLimitValue.value) || 0;
    const unit = parseInt(storageLimitUnit.value);
    storageLimitHidden.value = value > 0 ? value * unit : '';
  }
  
  if (storageLimitValue) storageLimitValue.addEventListener('input', updateStorageLimitHidden);
  if (storageLimitUnit) storageLimitUnit.addEventListener('change', updateStorageLimitHidden);
  
  // Handle delete button clicks
  document.querySelectorAll('.delete-user-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const userId = this.dataset.userId;
      const username = this.dataset.username;
      deleteUser(userId, username);
    });
  });
});

function closeEditModal() {
  const modal = document.getElementById('editModal');
  const modalContent = document.getElementById('editModalContent');
  
  modal.classList.add('opacity-0');
  modalContent.classList.remove('opacity-100', 'scale-100');
  modalContent.classList.add('opacity-0', 'scale-95');
  
  setTimeout(() => {
    modal.classList.add('hidden');
    document.getElementById('editUserForm').reset();
  }, 200);
}

document.getElementById('editAvatarInput').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('editUserAvatar').src = e.target.result;
    };
    reader.readAsDataURL(file);
  }
});

document.getElementById('createAvatarInput').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('createUserAvatar').src = e.target.result;
    };
    reader.readAsDataURL(file);
  }
});

document.getElementById('editUserForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  
  fetch('/api/users/update', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showToast('User updated successfully', 'success');
      closeEditModal();
      setTimeout(() => location.reload(), 1000);
    } else {
      showToast('Error: ' + data.message, 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showToast('An error occurred while updating user', 'error');
  });
});

document.getElementById('createUserForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  
  fetch('/api/users/create', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showToast('User created successfully', 'success');
      closeCreateModal();
      setTimeout(() => location.reload(), 1000);
    } else {
      showToast('Error: ' + data.message, 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showToast('An error occurred while creating user', 'error');
  });
});

function deleteUser(userId, username) {
  const title = 'Delete User';
  // Use textContent to safely display username with special characters
  const safeUsername = username || 'Unknown User';
  
  showConfirmModal(title, `Are you sure you want to delete this user? This action cannot be undone.`, () => {
    fetch('/api/users/delete', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ userId })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showToast('User deleted successfully', 'success');
        setTimeout(() => location.reload(), 1000);
      } else {
        showToast('Error: ' + data.message, 'error');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showToast('An error occurred while deleting user', 'error');
    });
  });
  
  // Update modal message with safe username display
  const modalMessage = document.getElementById('modalMessage');
  modalMessage.textContent = `Are you sure you want to delete user "${safeUsername}"? This action cannot be undone.`;
}

function showConfirmModal(title, message, onConfirm) {
  document.getElementById('modalTitle').textContent = title;
  document.getElementById('modalMessage').textContent = message;
  currentAction = onConfirm;
  
  const modal = document.getElementById('confirmModal');
  const modalContent = document.getElementById('confirmModalContent');
  
  modal.classList.remove('hidden');
  
  setTimeout(() => {
    modal.classList.remove('opacity-0');
    modalContent.classList.remove('opacity-0', 'scale-95');
    modalContent.classList.add('opacity-100', 'scale-100');
  }, 10);
}

function closeModal() {
  const modal = document.getElementById('confirmModal');
  const modalContent = document.getElementById('confirmModalContent');
  
  modal.classList.add('opacity-0');
  modalContent.classList.remove('opacity-100', 'scale-100');
  modalContent.classList.add('opacity-0', 'scale-95');
  
  setTimeout(() => {
    modal.classList.add('hidden');
    currentAction = null;
  }, 200);
}

function confirmAction() {
  if (currentAction) {
    currentAction();
  }
  closeModal();
}

document.getElementById('confirmButton').addEventListener('click', confirmAction);

document.getElementById('searchInput').addEventListener('input', filterUsers);
document.getElementById('roleFilter').addEventListener('change', filterUsers);
document.getElementById('statusFilter').addEventListener('change', filterUsers);

function filterUsers() {
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  const roleFilter = document.getElementById('roleFilter').value;
  const statusFilter = document.getElementById('statusFilter').value;
  
  const rows = document.querySelectorAll('.user-row');
  const defaultEmptyState = document.getElementById('defaultEmptyState');
  const searchEmptyState = document.getElementById('searchEmptyState');
  
  let visibleCount = 0;
  const hasFilters = searchTerm || roleFilter || statusFilter;
  
  rows.forEach(row => {
    const username = row.dataset.username;
    const role = row.dataset.role;
    const status = row.dataset.status;
    
    const matchesSearch = username.includes(searchTerm);
    const matchesRole = !roleFilter || role === roleFilter;
    const matchesStatus = !statusFilter || status === statusFilter;
    
    if (matchesSearch && matchesRole && matchesStatus) {
      row.style.display = '';
      visibleCount++;
    } else {
      row.style.display = 'none';
    }
  });
  
  if (defaultEmptyState) {
    defaultEmptyState.style.display = 'none';
  }
  
  if (hasFilters && visibleCount === 0) {
    searchEmptyState.classList.remove('hidden');
  } else {
    searchEmptyState.classList.add('hidden');
  }
  
  if (!hasFilters && visibleCount === 0 && defaultEmptyState) {
    defaultEmptyState.style.display = '';
  }
}

function showVideoModal(element) {
  const userId = element.dataset.userId;
  const username = element.dataset.username;
  
  const modal = document.getElementById('videoModal');
  const videoList = document.getElementById('videoList');
  const title = document.getElementById('videoModalTitle');
  
  title.textContent = `Videos by ${username}`;
  
  modal.classList.remove('opacity-0', 'pointer-events-none');
  modal.querySelector('.bg-dark-800').classList.remove('scale-95');
  
  videoList.innerHTML = '<div class="flex items-center justify-center p-8"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div></div>';
  
  fetch(`/api/users/${userId}/videos`)
    .then(response => response.json())
    .then(data => {
      const emptyState = document.getElementById('videoEmptyState');
      
      if (data.success && data.videos && data.videos.length > 0) {
        videoList.innerHTML = data.videos.map(video => `
          <div class="flex items-center justify-between p-4 bg-dark-700 rounded-lg border border-gray-600/50 hover:bg-dark-600/50 transition-colors">
            <div class="flex items-center space-x-4">
              <div class="w-16 h-12 bg-gray-600 rounded-lg overflow-hidden flex-shrink-0">
                ${video.thumbnail_path ? 
                  `<img src="${video.thumbnail_path}" alt="${video.title || video.filename}" class="w-full h-full object-cover" onerror="this.onerror=null; this.parentElement.innerHTML='<i class=\\'ti ti-video text-gray-400 text-lg\\' style=\\'display: flex; align-items: center; justify-content: center; height: 100%;\\' ></i>';">` :
                  `<i class="ti ti-video text-gray-400 text-lg" style="display: flex; align-items: center; justify-content: center; height: 100%;"></i>`
                }
              </div>
              <div class="flex-1 min-w-0">
                <p class="text-white font-medium truncate">${video.title || video.filename}</p>
                <div class="flex items-center space-x-2 mt-1">
                  <p class="text-gray-400 text-sm">${formatDate(video.created_at)}</p>
                  <span class="text-gray-500">•</span>
                  <p class="text-gray-400 text-sm">${formatDuration(video.duration)}</p>
                </div>
              </div>
            </div>
            <div class="flex items-center gap-2 flex-shrink-0">
              <span class="inline-flex px-2.5 py-1 text-xs font-medium rounded-md bg-primary/20 text-accent border border-primary/30">
                ${formatFileSize(video.file_size)}
              </span>
              <button onclick="playMemberVideo('${video.id}', '${(video.title || video.filename).replace(/'/g, "\\'")}')" 
                class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-green-600 hover:bg-green-500 text-white text-sm font-medium rounded-lg transition-colors" title="Play">
                <i class="ti ti-player-play"></i>
                <span>Play</span>
              </button>
            </div>
          </div>
        `).join('');
        emptyState.classList.add('hidden');
      } else {
        videoList.innerHTML = '';
        emptyState.classList.remove('hidden');
      }
    })
    .catch(error => {
      console.error('Error fetching videos:', error);
      document.getElementById('videoList').innerHTML = '<p class="text-red-400 text-center">Error loading videos</p>';
    });
}

function showStreamModal(element) {
  const userId = element.dataset.userId;
  const username = element.dataset.username;
  
  const modal = document.getElementById('streamModal');
  const streamList = document.getElementById('streamList');
  const title = document.getElementById('streamModalTitle');
  
  title.textContent = `Streams by ${username}`;
  
  modal.classList.remove('opacity-0', 'pointer-events-none');
  modal.querySelector('.bg-dark-800').classList.remove('scale-95');
  
  streamList.innerHTML = '<div class="flex items-center justify-center p-8"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-red-500"></div></div>';
  
  fetch(`/api/users/${userId}/streams`)
    .then(response => response.json())
    .then(data => {
      const streamList = document.getElementById('streamList');
      const emptyState = document.getElementById('streamEmptyState');
      
      if (data.success && data.streams && data.streams.length > 0) {
        // Desktop: Table view, Mobile: Card view
        streamList.innerHTML = `
          <!-- Desktop Table View -->
          <div class="hidden md:block overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-dark-600 text-gray-400 text-xs uppercase">
                <tr>
                  <th class="px-3 py-2 text-left">Title</th>
                  <th class="px-3 py-2 text-left">Platform</th>
                  <th class="px-3 py-2 text-left">Created</th>
                  <th class="px-3 py-2 text-center">Status</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-700">
                ${data.streams.map(stream => `
                  <tr class="hover:bg-dark-600/50 transition-colors">
                    <td class="px-3 py-2">
                      <span class="text-white font-medium truncate block max-w-[200px]" title="${stream.title}">${stream.title}</span>
                    </td>
                    <td class="px-3 py-2 text-gray-400">${stream.platform || '-'}</td>
                    <td class="px-3 py-2 text-gray-400 whitespace-nowrap">${formatDateShort(stream.created_at)}</td>
                    <td class="px-3 py-2 text-center">
                      <span class="inline-flex items-center px-2 py-0.5 text-xs font-medium rounded ${
                        stream.status === 'live' ? 'bg-red-600/20 text-red-300' : 
                        stream.status === 'scheduled' ? 'bg-yellow-600/20 text-yellow-300' :
                        'bg-gray-600/20 text-gray-400'
                      }">
                        ${stream.status === 'live' ? '<span class="w-1.5 h-1.5 rounded-full bg-red-400 animate-pulse mr-1"></span>' : ''}
                        ${stream.status === 'live' ? 'Live' : stream.status === 'scheduled' ? 'Scheduled' : 'Offline'}
                      </span>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
          <!-- Mobile Card View -->
          <div class="md:hidden space-y-2">
            ${data.streams.map(stream => `
              <div class="flex items-center justify-between p-3 bg-dark-700 rounded-lg">
                <div class="flex-1 min-w-0 mr-3">
                  <p class="text-white text-sm font-medium truncate">${stream.title}</p>
                  <p class="text-gray-400 text-xs mt-0.5">${stream.platform || '-'} • ${formatDateShort(stream.created_at)}</p>
                </div>
                <span class="inline-flex items-center px-2 py-0.5 text-xs font-medium rounded flex-shrink-0 ${
                  stream.status === 'live' ? 'bg-red-600/20 text-red-300' : 
                  stream.status === 'scheduled' ? 'bg-yellow-600/20 text-yellow-300' :
                  'bg-gray-600/20 text-gray-400'
                }">
                  ${stream.status === 'live' ? '<span class="w-1.5 h-1.5 rounded-full bg-red-400 animate-pulse mr-1"></span>' : ''}
                  ${stream.status === 'live' ? 'Live' : stream.status === 'scheduled' ? 'Scheduled' : 'Offline'}
                </span>
              </div>
            `).join('')}
          </div>
        `;
        emptyState.classList.add('hidden');
      } else {
        streamList.innerHTML = '';
        emptyState.classList.remove('hidden');
      }
    })
    .catch(error => {
      console.error('Error fetching streams:', error);
      document.getElementById('streamList').innerHTML = '<p class="text-red-400 text-center">Error loading streams</p>';
    });
}

function formatDateShort(dateString) {
  if (!dateString) return '-';
  const date = new Date(dateString);
  return date.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
}

function closeVideoModal() {
  const modal = document.getElementById('videoModal');
  modal.querySelector('.bg-dark-800').classList.add('scale-95');
  modal.classList.add('opacity-0', 'pointer-events-none');
}

function playMemberVideo(videoId, videoTitle) {
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm';
  modal.id = 'video-player-modal';
  modal.innerHTML = `
    <div class="relative w-full max-w-4xl mx-auto">
      <div class="bg-dark-800 rounded-lg overflow-hidden shadow-xl">
        <div class="flex items-center justify-between p-4 border-b border-gray-600">
          <h3 class="text-lg font-medium">${videoTitle}</h3>
          <button id="close-player-btn" class="rounded-full w-8 h-8 flex items-center justify-center text-gray-400 hover:text-white hover:bg-gray-700">
            <i class="ti ti-x"></i>
          </button>
        </div>
        <div class="bg-dark-700 flex justify-center" style="height: 53vh;">
          <video id="native-player" class="h-full max-w-full object-contain" controls autoplay>
            <source src="/stream/${videoId}" type="video/mp4">
          </video>
        </div>
      </div>
    </div>`;
  document.body.appendChild(modal);
  document.getElementById('close-player-btn').onclick = () => { document.getElementById('native-player').pause(); modal.remove(); };
  modal.onclick = (e) => { if (e.target === modal) { document.getElementById('native-player').pause(); modal.remove(); } };
}

function closeStreamModal() {
  const modal = document.getElementById('streamModal');
  modal.querySelector('.bg-dark-800').classList.add('scale-95');
  modal.classList.add('opacity-0', 'pointer-events-none');
}

function formatDate(dateString) {
      if (!dateString) return 'Unknown';
      const date = new Date(dateString);
      return date.toLocaleDateString('id-ID', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      }) + ' ' + date.toLocaleTimeString('id-ID', {
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function formatFileSize(bytes) {
      if (!bytes || bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function formatDuration(seconds) {
      if (!seconds || seconds === 0) return '00:00:00';
      
      const totalSeconds = Math.floor(parseFloat(seconds));
      const hours = Math.floor(totalSeconds / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      const secs = totalSeconds % 60;
      
      return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

// Permission Management Functions
function togglePermission(userId, permission, currentValue) {
  const newValue = currentValue === 1 ? false : true;
  
  fetch('/api/users/permission', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ userId, permission, value: newValue })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Update button appearance
      const permType = permission.replace('can_', '').replace('_videos', '');
      const btn = document.getElementById(`perm-${permType}-${userId}`);
      if (btn) {
        const permLabel = permType.charAt(0).toUpperCase() + permType.slice(1);
        if (newValue) {
          btn.className = 'permission-btn p-1.5 rounded-lg transition-colors bg-green-600/20 text-green-400 hover:bg-green-600/30';
          btn.title = `${permLabel}: ON`;
        } else {
          btn.className = 'permission-btn p-1.5 rounded-lg transition-colors bg-red-600/20 text-red-400 hover:bg-red-600/30';
          btn.title = `${permLabel}: OFF`;
        }
        // Update onclick with new value
        btn.setAttribute('onclick', `event.stopPropagation(); togglePermission('${userId}', '${permission}', ${newValue ? 1 : 0})`);
      }
      showToast('Permission updated', 'success');
    } else {
      showToast('Error: ' + data.message, 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showToast('Failed to update permission', 'error');
  });
}

</script>